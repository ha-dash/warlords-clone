# Формат Файла Карты (Map File Format)

## Анализ Структуры Данных

### Данные для Сохранения

#### 1. Метаданные Карты
- **Размеры**: `width`, `height` (целые числа)
- **Размер карты**: `mapSize` ('small' | 'medium' | 'large' | 'very-large')
- **Версия формата**: для совместимости при обновлениях
- **Дата создания/изменения**: для отслеживания версий
- **Опционально**: название, описание

#### 2. Гексы (Hexes)
Каждая позиция на карте может содержать **стек гексов** (до 5 уровней высоты):

**Обязательные поля:**
- `x`, `y` - координаты (0-based)
- `terrain` - тип местности (PLAINS, FOREST, MOUNTAIN, WATER, ROAD)
- `height` - уровень высоты (0-4)

**Опциональные поля:**
- `rotation` - вращение в радианах (по умолчанию 0)
- `modelData` - данные модели 3D:
  - `obj` - путь к .obj файлу
  - `mtl` - путь к .mtl файлу
  - `name` - имя модели
- `hasRiver` - наличие реки (boolean)

#### 3. Здания (Buildings)
Здания хранятся отдельно от гексов:
- `x`, `y` - координаты
- `height` - опциональный уровень высоты
- `modelData` - данные модели (аналогично гексам)

## Выбранный Формат: Оптимизированный JSON

### Обоснование Выбора

**JSON выбран по следующим причинам:**

1. **Читаемость**: Легко отлаживать и редактировать вручную
2. **Стандартность**: Нативная поддержка в JavaScript/TypeScript
3. **Расширяемость**: Легко добавлять новые поля без breaking changes
4. **Совместимость**: Работает с любыми инструментами (текстовые редакторы, Git, etc.)

### Оптимизации Формата

#### 1. Sparse Array (Разреженный массив)
Вместо хранения всех позиций карты, сохраняются только **непустые позиции**:
```json
{
  "hexes": {
    "0,0": [...],  // Только позиции с гексами
    "5,3": [...],
    "10,7": [...]
  }
}
```
**Экономия**: Для карты 100×100 с заполненностью 30% экономия ~70% размера файла.

#### 2. Минимизация Повторяющихся Данных
- Пропуск значений по умолчанию (`rotation: 0`, `height: 0`)
- Короткие ключи (`"x,y"` вместо `{"x": x, "y": y}`)

#### 3. Компрессия (Опционально)
JSON можно сжать через gzip для дополнительной экономии (50-80% для больших карт).

### Структура Файла

```json
{
  "version": "1.0",
  "format": "warlords-map",
  "metadata": {
    "name": "My Custom Map",
    "description": "A custom map description",
    "createdAt": 1703689200000,
    "modifiedAt": 1703689200000,
    "mapSize": "medium"
  },
  "map": {
    "width": 50,
    "height": 50
  },
  "hexes": {
    "0,0": [
      {
        "x": 0,
        "y": 0,
        "terrain": "PLAINS",
        "height": 0,
        "modelData": {
          "obj": "/assets/terrain/tiles/base/tile_01.obj",
          "mtl": "/assets/terrain/tiles/base/tile_01.mtl",
          "name": "tile_01"
        }
      }
    ],
    "5,3": [
      {
        "x": 5,
        "y": 3,
        "terrain": "MOUNTAIN",
        "height": 0,
        "rotation": 1.047,
        "modelData": {
          "obj": "/assets/terrain/tiles/base/tile_02.obj",
          "mtl": "/assets/terrain/tiles/base/tile_02.mtl",
          "name": "tile_02"
        }
      },
      {
        "x": 5,
        "y": 3,
        "terrain": "FOREST",
        "height": 1,
        "modelData": {
          "obj": "/assets/terrain/decoration/nature/tree_01.obj",
          "mtl": "/assets/terrain/decoration/nature/tree_01.mtl",
          "name": "tree_01"
        }
      }
    ]
  },
  "buildings": [
    {
      "x": 10,
      "y": 10,
      "height": 0,
      "modelData": {
        "obj": "/assets/terrain/buildings/blue/building_01.obj",
        "mtl": "/assets/terrain/buildings/blue/building_01.mtl",
        "name": "building_01"
      }
    }
  ]
}
```

## Оценка Размера Файла

### Примеры

| Размер карты | Заполненность | Гексы | Примерный размер |
|--------------|---------------|-------|------------------|
| 25×25 (small) | 100% | 625 | ~125 KB |
| 50×50 (medium) | 50% | 1,250 | ~250 KB |
| 75×75 (large) | 30% | 1,688 | ~340 KB |
| 100×100 (very-large) | 20% | 2,000 | ~400 KB |

**Формула**: `Размер ≈ (Количество гексов × 200 байт) + 500 байт (overhead)`

### Оптимизация через gzip

При сжатии gzip размер уменьшается на **50-80%**:
- Small: ~125 KB → ~30-60 KB
- Medium: ~250 KB → ~60-120 KB
- Large: ~340 KB → ~85-170 KB
- Very Large: ~400 KB → ~100-200 KB

## Версионирование

Формат использует семантическое версионирование:
- **Major** (1.x.x): Breaking changes (несовместимые изменения)
- **Minor** (x.1.x): Новые функции (обратно совместимые)
- **Patch** (x.x.1): Исправления ошибок

При загрузке файлов с другой версией:
- **Major mismatch**: Предупреждение, попытка загрузки с миграцией (если реализована)
- **Minor/Patch mismatch**: Предупреждение, но загрузка продолжается

## Расширяемость

Формат легко расширяется без breaking changes:

1. **Новые поля в metadata**: Игнорируются старыми версиями
2. **Новые поля в hexes**: Опциональные поля не ломают загрузку
3. **Новые типы данных**: Можно добавить новые секции (например, `decorations`, `units`)

## Альтернативные Форматы (Рассмотренные)

### Binary Format
**Плюсы:**
- Максимальная компактность (~30-50% от JSON)
- Быстрая загрузка

**Минусы:**
- Сложность отладки
- Невозможность ручного редактирования
- Требует специальных инструментов

**Вывод**: Не подходит для редактора карт, где важна читаемость.

### XML
**Плюсы:**
- Читаемость
- Валидация через XSD

**Минусы:**
- Больший размер (~2x от JSON)
- Более сложный парсинг

**Вывод**: JSON предпочтительнее для веб-приложений.

### MessagePack
**Плюсы:**
- Компактность (как binary, но с JSON-подобной структурой)
- Быстрый парсинг

**Минусы:**
- Требует библиотеку
- Менее читаем для человека

**Вывод**: Можно использовать в будущем для оптимизации, но JSON достаточен сейчас.

## Рекомендации

1. **Текущий формат (JSON) оптимален** для редактора карт
2. **Добавить gzip сжатие** при необходимости (для больших карт)
3. **Версионирование критично** для долгосрочной поддержки
4. **Sparse array** - ключевая оптимизация для экономии места

## Реализация

Формат реализован в `editor-nextjs/lib/game/MapSerializer.ts`:
- `MapSerializer.serialize()` - сохранение карты
- `MapSerializer.deserialize()` - загрузка карты
- `MapSerializer.validate()` - валидация структуры

Использование в редакторе:
- Кнопка "Save" - сохраняет карту в JSON файл
- Кнопка "Open" - загружает карту из JSON файла

